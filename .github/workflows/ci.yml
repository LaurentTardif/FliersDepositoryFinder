name: CI - Tests et QualitÃ© du Code

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

jobs:
    test-and-lint:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.9", "3.10", "3.11", "3.12"]

        steps:
            - name: ğŸ“¥ RÃ©cupÃ©ration du code
              uses: actions/checkout@v4

            - name: ğŸ Configuration Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: ğŸ“¦ Installation des dÃ©pendances
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8 black isort mypy requests
                  # Installation des dÃ©pendances si requirements.txt existe
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: ğŸ” Linting avec flake8
              run: |
                  echo "ğŸ” VÃ©rification de la qualitÃ© du code avec flake8..."
                  # Stop la construction si il y a des erreurs de syntaxe Python ou des noms non dÃ©finis
                  flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Avertissements pour les autres problÃ¨mes (ne fait pas Ã©chouer la CI)
                  flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

            - name: ğŸ¨ VÃ©rification du formatage avec Black
              run: |
                  echo "ğŸ¨ VÃ©rification du formatage du code avec Black..."
                  black --check --diff .

            - name: ğŸ“‹ VÃ©rification des imports avec isort
              run: |
                  echo "ğŸ“‹ VÃ©rification de l'ordre des imports avec isort..."
                  isort --check-only --diff .

            - name: ğŸ·ï¸ VÃ©rification des types avec mypy (optionnel)
              run: |
                  echo "ğŸ·ï¸ VÃ©rification des types avec mypy..."
                  # ExÃ©cution avec --ignore-missing-imports pour Ã©viter les erreurs sur les modules externes
                  mypy . --ignore-missing-imports --python-version=${{ matrix.python-version }} || echo "âš ï¸ Avertissements mypy dÃ©tectÃ©s"
              continue-on-error: true

            - name: ğŸ§ª ExÃ©cution des tests
              run: |
                  echo "ğŸ§ª ExÃ©cution de tous les tests..."
                  export PYTHONIOENCODING=utf-8
                  python tests/run_all_tests.py

            - name: ğŸ“Š Rapport de couverture de tests (optionnel)
              run: |
                  echo "ğŸ“Š Installation et exÃ©cution de la couverture de tests..."
                  pip install coverage
                  export PYTHONIOENCODING=utf-8
                  coverage run tests/run_all_tests.py
                  coverage report
                  coverage xml
              continue-on-error: true

            - name: ğŸ“¤ Upload des rÃ©sultats de couverture
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
              continue-on-error: true

    # Job sÃ©parÃ© pour Windows (optionnel, car ton projet est dÃ©veloppÃ© sur Windows)
    test-windows:
        runs-on: windows-latest
        steps:
            - name: ğŸ“¥ RÃ©cupÃ©ration du code
              uses: actions/checkout@v4

            - name: ğŸ Configuration Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: ğŸ“¦ Installation des dÃ©pendances
              run: |
                  python -m pip install --upgrade pip
                  pip install requests

            - name: ğŸ§ª Tests sur Windows
              run: |
                  $env:PYTHONIOENCODING='utf-8'
                  python tests/run_all_tests.py
